#!/bin/bash
set -o errexit

rm -rf .env
cp -f .env.sample .env

export DB_HOST=127.0.0.1
export DB_PORT=5432
bin/start-db-redis-containers

#bundle config set force_ruby_platform true &&

docker compose run --rm web bash -c '
  bin/wait-for-services &&
  bundle config --local local.spree ../spree_43 &&
  echo "vvvvafffancuuulo" &&
  bundle config --local local.spree_frontend ../spree_43/frontend &&
  echo "vvvvafffancuuulo1" &&
  bundle config &&
  echo "vvvvafffancuuulo2" &&
  (bundle check || bundle install) &&
  echo "1pippo" &&
  bin/rails db:environment:set RAILS_ENV=development
  echo "1apippo" &&
  bundle exec rails --trace db:drop &&
  echo "2pippo" &&
  bundle exec rails db:create &&
  echo "3pippo" &&
  bundle exec rails db:migrate &&
  echo "4pippo" &&
  bundle exec rails db:seed &&
  echo "5pippo" &&
  rm -rf tmp/latest.dump &&
  echo "6pippo"
'
