#!/bin/bash
set -o errexit

rm -rf .env
cp -f .env.sample .env

export DB_HOST=127.0.0.1
export DB_PORT=5432
bin/start-db-redis-containers

#bundle exec rails --trace db:drop &&
# bundle exec rails db:create &&
#   echo "3pippo" &&
#   bundle exec rails db:migrate &&
#   echo "4pippo" &&
#   bundle exec rails db:seed &&

docker compose run --rm web bash -c '
  bin/wait-for-services &&
  bundle config set force_ruby_platform true &&
  (bundle check || bundle install) &&
  echo "1pippo" &&
  bin/rails db:environment:set RAILS_ENV=development
  echo "1apippo" &&
  echo "2pippo" &&
  echo "5pippo" &&
  rm -rf tmp/latest.dump &&
  echo "6pippo"
'
